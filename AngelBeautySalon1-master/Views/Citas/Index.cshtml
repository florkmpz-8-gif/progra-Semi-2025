@model IEnumerable<AngelBeautySalon1.Models.Cita>

@{
    ViewData["Title"] = "Citas";
}

<div class="container mt-4">
    <div class="row">
        <div class="col-md-12">
            <h2 class="mb-4">
                <i class="fas fa-calendar-alt"></i> Gestión de Citas
            </h2>

            @if (TempData["Success"] != null)
            {
                <div class="alert alert-success alert-dismissible fade show" role="alert">
                    @TempData["Success"]
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            }

            @if (TempData["Error"] != null)
            {
                <div class="alert alert-danger alert-dismissible fade show" role="alert">
                    @TempData["Error"]
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            }
        </div>
    </div>

    <!-- Filtros de búsqueda avanzada -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card shadow-sm">
                <div class="card-body">
                    <form asp-action="Index" method="get" class="row g-3">
                        <div class="col-md-4">
                            <label class="form-label">Buscar</label>
                            <div class="input-group">
                                <span class="input-group-text">
                                    <i class="fas fa-search"></i>
                                </span>
                                <input type="text" 
                                       class="form-control" 
                                       name="searchString" 
                                       id="searchInput"
                                       value="@ViewData["CurrentFilter"]" 
                                       placeholder="Cliente, servicio o estado...">
                            </div>
                        </div>

                        <div class="col-md-2">
                            <label class="form-label">Fecha Desde</label>
                            <input type="date" 
                                   class="form-control" 
                                   name="fechaDesde" 
                                   value="@ViewData["FechaDesde"]">
                        </div>

                        <div class="col-md-2">
                            <label class="form-label">Fecha Hasta</label>
                            <input type="date" 
                                   class="form-control" 
                                   name="fechaHasta" 
                                   value="@ViewData["FechaHasta"]">
                        </div>

                        <div class="col-md-2">
                            <label class="form-label">Cliente</label>
                            <select name="clienteId" class="form-select">
                                <option value="">Todos</option>
                                @foreach (var cliente in ViewBag.Clientes as SelectList)
                                {
                                    <option value="@cliente.Value" selected="@(cliente.Value == ViewData["ClienteId"]?.ToString())">
                                        @cliente.Text
                                    </option>
                                }
                            </select>
                        </div>

                        <div class="col-md-2">
                            <label class="form-label">&nbsp;</label>
                            <div class="d-grid gap-2">
                                <button class="btn btn-primary" type="submit">
                                    <i class="fas fa-filter"></i> Filtrar
                                </button>
                            </div>
                        </div>
                    </form>

                    <div class="row mt-3">
                        <div class="col-md-12">
                            @if (!string.IsNullOrEmpty(ViewData["CurrentFilter"]?.ToString()) || 
                                 ViewData["FechaDesde"] != null || 
                                 ViewData["FechaHasta"] != null || 
                                 ViewData["ClienteId"] != null)
                            {
                                <a asp-action="Index" class="btn btn-outline-danger btn-sm">
                                    <i class="fas fa-times"></i> Limpiar Filtros
                                </a>
                            }
                            <a asp-action="Create" class="btn btn-success btn-sm float-end">
                                <i class="fas fa-plus"></i> Nueva Cita
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Búsqueda rápida del día -->
    <div class="row mb-3">
        <div class="col-md-12">
            <div class="card border-info">
                <div class="card-body">
                    <h6 class="card-title">
                        <i class="fas fa-calendar-day"></i> Búsqueda Rápida - Citas del Día
                    </h6>
                    <div class="row">
                        <div class="col-md-4">
                            <input type="date" class="form-control" id="fechaBusquedaRapida" value="@DateTime.Now.ToString("yyyy-MM-dd")">
                        </div>
                        <div class="col-md-3">
                            <button class="btn btn-info" onclick="buscarCitasDelDia()">
                                <i class="fas fa-search"></i> Buscar
                            </button>
                        </div>
                    </div>
                    <div id="resultadosCitasDelDia" class="mt-3"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tabla de citas -->
    <div class="row">
        <div class="col-md-12">
            <div class="card shadow-sm">
                <div class="card-body">
                    @if (Model.Any())
                    {
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead class="table-light">
                                    <tr>
                                        <th>Fecha y Hora</th>
                                        <th>Cliente</th>
                                        <th>Servicio</th>
                                        <th>Duración</th>
                                        <th>Estado</th>
                                        <th>Notas</th>
                                        <th class="text-center">Acciones</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var cita in Model)
                                    {
                                        var estadoClass = cita.Estado switch
                                        {
                                            "Confirmada" => "success",
                                            "Pendiente" => "warning",
                                            "Completada" => "info",
                                            "Cancelada" => "danger",
                                            _ => "secondary"
                                        };

                                        <tr>
                                            <td>cita.FechaHora.ToString("dd/MM/yyyy HH:mm")</td>
                                            <td>cita.Cliente.Nombre cita.Cliente.Apellido</td>
                                            <td>cita.Servicio.Nombre</td>
                                            <td>cita.Servicio.DuracionMinutos min</td>
                                            <td>
                                                <span class="badge bg-estadoClass">cita.Estado</span>
                                            </td>
                                            <td>
                                                if (!string.IsNullOrEmpty(cita.Notas))
                                                {
                                                    <span title="@cita.Notas">
                                                        (cita.Notas.Length > 30 ? cita.Notas.Substring(0, 30) + "..." : cita.Notas)
                                                    </span>
                                                }
                                            </td>
                                            <td class="text-center">
                                                <a asp-action="Edit" asp-route-id="cita.CitaId" 
                                                   class="btn btn-sm btn-warning" title="Editar">
                                                    <i class="fas fa-edit"></i>
                                                </a>
                                                <a asp-action="Delete" asp-route-id="cita.CitaId" 
                                                   class="btn btn-sm btn-danger" title="Eliminar">
                                                    <i class="fas fa-trash"></i>
                                                </a>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    }
                    else
                    {
                        <div class="alert alert-info text-center">
                            <i class="fas fa-info-circle"></i>
                            <p class="mb-0">No se encontraron citas con los filtros aplicados.</p>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

Scripts {
    <script>
        function buscarCitasDelDia() {
            const fecha = document.getElementById('fechaBusquedaRapida').value;
            const resultadosDiv = document.getElementById('resultadosCitasDelDia');
            
            resultadosDiv.innerHTML = '<div class="text-center"><i class="fas fa-spinner fa-spin"></i> Buscando...</div>';

            fetch(`/Citas/BuscarAjax?fecha=${fecha}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.data.length > 0) {
                        let html = '<div class="table-responsive"><table class="table table-sm table-bordered">';
                        html += '<thead><tr><th>Hora</th><th>Cliente</th><th>Servicio</th><th>Estado</th><th>Duración</th></tr></thead><tbody>';
                        
                        data.data.forEach(cita => {
                            const estadoClass = cita.estado === 'Confirmada' ? 'success' : 
                                              cita.estado === 'Pendiente' ? 'warning' : 
                                              cita.estado === 'Completada' ? 'info' : 'danger';
                            
                            html += `<tr>
                                <td>${cita.fecha}</td>
                                <td>${cita.cliente}</td>
                                <td>${cita.servicio}</td>
                                <td><span class="badge bg-${estadoClass}">${cita.estado}</span></td>
                                <td>${cita.duracion} min</td>
                            </tr>`;
                        });
                        
                        html += '</tbody></table></div>';
                        resultadosDiv.innerHTML = html;
                    } else {
                        resultadosDiv.innerHTML = '<div class="alert alert-warning">No hay citas para esta fecha.</div>';
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    resultadosDiv.innerHTML = '<div class="alert alert-danger">Error al buscar citas.</div>';
                });
        }

        // Buscar citas del día actual al cargar la página
        document.addEventListener('DOMContentLoaded', function() {
            buscarCitasDelDia();
        });
    </script>
}
