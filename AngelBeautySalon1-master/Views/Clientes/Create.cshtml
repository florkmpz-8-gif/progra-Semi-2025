@model AngelBeautySalon1.Models.Cliente

@{
    ViewData["Title"] = "Crear Cliente";
}

<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">
                        <i class="fas fa-user-plus"></i> Crear Nuevo Cliente
                    </h4>
                </div>
                <div class="card-body">
                    <form asp-action="Create" id="formCliente" novalidate>
                        <div asp-validation-summary="ModelOnly" class="alert alert-danger"></div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label asp-for="Nombre" class="form-label">Nombre <span class="text-danger">*</span></label>
                                <input asp-for="Nombre" class="form-control" required minlength="2" maxlength="50" />
                                <span asp-validation-for="Nombre" class="text-danger"></span>
                                <div class="invalid-feedback">
                                    El nombre es obligatorio y debe tener entre 2 y 50 caracteres.
                                </div>
                            </div>

                            <div class="col-md-6 mb-3">
                                <label asp-for="Apellido" class="form-label">Apellido <span class="text-danger">*</span></label>
                                <input asp-for="Apellido" class="form-control" required minlength="2" maxlength="50" />
                                <span asp-validation-for="Apellido" class="text-danger"></span>
                                <div class="invalid-feedback">
                                    El apellido es obligatorio y debe tener entre 2 y 50 caracteres.
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label asp-for="Telefono" class="form-label">Teléfono <span class="text-danger">*</span></label>
                                <input asp-for="Telefono" class="form-control" type="tel" required pattern="[0-9]{8,10}" />
                                <span asp-validation-for="Telefono" class="text-danger"></span>
                                <div class="invalid-feedback">
                                    El teléfono debe contener entre 8 y 10 dígitos.
                                </div>
                                <small class="form-text text-muted">Ejemplo: 77889900</small>
                            </div>

                            <div class="col-md-6 mb-3">
                                <label asp-for="Email" class="form-label">Email <span class="text-danger">*</span></label>
                                <input asp-for="Email" class="form-control" type="email" required />
                                <span asp-validation-for="Email" class="text-danger"></span>
                                <div class="invalid-feedback">
                                    Por favor ingrese un email válido.
                                </div>
                                <small class="form-text text-muted">Ejemplo: cliente@email.com</small>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label asp-for="Direccion" class="form-label">Dirección</label>
                            <textarea asp-for="Direccion" class="form-control" rows="2" maxlength="200"></textarea>
                            <span asp-validation-for="Direccion" class="text-danger"></span>
                            <small class="form-text text-muted">Máximo 200 caracteres</small>
                        </div>

                        <div class="mb-3">
                            <label asp-for="FechaNacimiento" class="form-label">Fecha de Nacimiento <span class="text-danger">*</span></label>
                            <input asp-for="FechaNacimiento" class="form-control" type="date" required id="fechaNacimiento" />
                            <span asp-validation-for="FechaNacimiento" class="text-danger"></span>
                            <div class="invalid-feedback">
                                La fecha de nacimiento es obligatoria y el cliente debe ser mayor de 18 años.
                            </div>
                        </div>

                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i> Los campos marcados con <span class="text-danger">*</span> son obligatorios.
                        </div>

                        <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                            <a asp-action="Index" class="btn btn-secondary">
                                <i class="fas fa-arrow-left"></i> Cancelar
                            </a>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save"></i> Guardar Cliente
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
    
    <script>
        // Validación personalizada para edad mínima (18 años)
        const fechaNacimientoInput = document.getElementById('fechaNacimiento');
        
        // Establecer fecha máxima (18 años atrás desde hoy)
        const hoy = new Date();
        const fechaMaxima = new Date(hoy.getFullYear() - 18, hoy.getMonth(), hoy.getDate());
        fechaNacimientoInput.max = fechaMaxima.toISOString().split('T')[0];

        // Validación del formulario
        const form = document.getElementById('formCliente');
        form.addEventListener('submit', function(event) {
            if (!form.checkValidity()) {
                event.preventDefault();
                event.stopPropagation();
            } else {
                // Validar edad
                const fechaNac = new Date(fechaNacimientoInput.value);
                const edad = calcularEdad(fechaNac);
                
                if (edad < 18) {
                    event.preventDefault();
                    fechaNacimientoInput.setCustomValidity('El cliente debe ser mayor de 18 años');
                    fechaNacimientoInput.reportValidity();
                    return false;
                } else {
                    fechaNacimientoInput.setCustomValidity('');
                }
            }

            form.classList.add('was-validated');
        }, false);

        // Validación en tiempo real del teléfono
        const telefonoInput = document.querySelector('input[name="Telefono"]');
        telefonoInput.addEventListener('input', function(e) {
            // Permitir solo números
            this.value = this.value.replace(/[^0-9]/g, '');
        });

        // Función para calcular edad
        function calcularEdad(fechaNacimiento) {
            const hoy = new Date();
            let edad = hoy.getFullYear() - fechaNacimiento.getFullYear();
            const mes = hoy.getMonth() - fechaNacimiento.getMonth();
            
            if (mes < 0 || (mes === 0 && hoy.getDate() < fechaNacimiento.getDate())) {
                edad--;
            }
            
            return edad;
        }

        // Validación del email en tiempo real
        const emailInput = document.querySelector('input[name="Email"]');
        emailInput.addEventListener('blur', function() {
            const emailRegex = /^[^\s]+[^\s]+\.[^\s]+$/;
            if (this.value && !emailRegex.test(this.value)) {
                this.setCustomValidity('Por favor ingrese un email válido');
            } else {
                this.setCustomValidity('');
            }
        });

        // Limpiar validación personalizada al escribir
        fechaNacimientoInput.addEventListener('input', function() {
            this.setCustomValidity('');
        });

        emailInput.addEventListener('input', function() {
            this.setCustomValidity('');
        });
    </script>
}
